{% load static %}
{% load custom_filters %}
{% include 'lolapp/header.html' %}
<link rel="stylesheet" href="{% static 'header.css' %}">
<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <title>ì „ì ê²€ìƒ‰</title>
    <style>
        body { background: #23232b; font-family: 'Segoe UI', Arial, sans-serif; color: #e0e0e0; }
        .container { max-width: 1500px; margin: 24px auto; background: #23232b; border-radius: 10px; padding: 0; }
        .search-bar { display: flex; gap: 8px; margin-bottom: 24px; }
        .search-bar input { flex: 1; padding: 8px; border: 1px solid #444; border-radius: 4px; background: #181820; color: #fff; }
        .search-bar button { padding: 8px 16px; background: #1976d2; color: #fff; border: none; border-radius: 4px; cursor: pointer; }
        .section-title { font-size: 1.2em; margin: 32px 0 12px 0; color: #90caf9; }
        .champion-list { display: flex; flex-direction: column; gap: 8px; }
        .champion-card { display: flex; align-items: center; background: #32323e; border-radius: 8px; padding: 12px 20px; }
        .champion-card img { width: 48px; height: 48px; border-radius: 50%; margin-right: 16px; }
        .champion-info { flex: 1; }
        .champion-name { font-weight: bold; font-size: 1.1em; }
        .champion-cs { font-size: 0.95em; color: #bdbdbd; }
        .champion-kda { color: #4caf50; font-weight: bold; margin-left: 12px; }
        .champion-score { color: #26c6da; margin-left: 12px; }
        .champion-winrate { margin-left: 12px; font-weight: bold; }
        .champion-winrate.red { color: #ef5350; }
        .champion-winrate.green { color: #81c784; }
        .champion-games { margin-left: 12px; color: #bdbdbd; }
        .team-list { background: #23232b; border-radius: 8px; padding: 8px 12px; margin-bottom: 16px; }
        .team-user { display: flex; align-items: center; padding: 8px 0; border-bottom: 1px solid #333; }
        .team-user:last-child { border-bottom: none; }
        .team-user img { width: 36px; height: 36px; border-radius: 50%; margin-right: 12px; }
        .team-user-info { flex: 1; }
        .team-user-name { font-weight: bold; }
        .team-user-level { font-size: 0.95em; color: #bdbdbd; margin-left: 8px; }
        .team-user-record { margin-right: 24px; }
        .team-user-winrate { font-weight: bold; min-width: 48px; text-align: right; }
        .team-user-winrate.red { color: #ef5350; }
        .team-user-winrate.green { color: #81c784; }
        .game-list { display: flex; flex-direction: column; gap: 12px; padding-left: 24px; padding-right: 24px; }
        .game-card { background: #26324a; border-radius: 8px; padding: 16px 20px; display: flex; align-items: center; border-left: 6px solid #1976d2; position: relative; }
        .game-card.lose { border-left: 6px solid #ef5350; }
        .game-champion { display: flex; align-items: center; margin-right: 20px; }
        .game-champion img { width: 40px; height: 40px; border-radius: 50%; margin-right: 8px; }
        .game-info { flex: 1; }
        .game-kda { font-size: 1.1em; font-weight: bold; }
        .game-kda .death { color: #ef5350; }
        .game-kda .score { color: #4caf50; margin-left: 8px; }
        .game-detail { font-size: 0.95em; color: #bdbdbd; margin-top: 2px; }
        .game-vs { min-width: 80px; text-align: right; font-size: 1em; color: #bdbdbd; }

        /* â–¼ ì¶”ê°€: ë™ì¼ ë†’ì´/í­ ì •ë ¬ìš© ë³´ì¡° í´ë˜ìŠ¤ë“¤ */
        .content-grid {
            display: flex;
            flex-direction: row;
            gap: 24px;
            align-items: stretch;
            margin-top: 0;
        }
        .panel {
            background: #23232b;
            border-radius: 24px;
            padding: 18px 12px;
            flex: 0 0 320px;
            min-width: 260px;
            max-width: 340px;
            height: 100%;
            display: flex;
            flex-direction: column;
        }
        .panel-large {
            background: #23232b;
            border-radius: 32px;
            padding: 24px 18px;
            min-width: 800px;
            max-width: 1600px;
            width: 100%;
            flex: 1 1 0%;
            margin: 0 auto;
            margin-left: auto;
            margin-right: auto;
            height: 100%;
            display: flex;
            flex-direction: column;
        }
        .score-card {
            background: #23232b;
            border-radius: 16px;  /* recent-summaryì™€ í†¤ì„ ë§ì¶¤ */
            padding: 24px 32px;
            margin: 0 0 32px 0;
            box-shadow: 0 2px 8px #0002;
        }
        .score-card-inner {
            background: #1a1a22;
            border-radius: 12px;
            padding: 16px;
        }

        /* ë°˜ì‘í˜•(ì˜µì…˜) : ì¢Œì¸¡ í­ ì¶•ì†Œ */
        @media (max-width: 1280px) {
            .container { max-width: 98vw; }
            .content-grid { flex-direction: column; gap: 16px; }
            .panel, .panel-large { min-width: 0; max-width: 100%; }
        }
        @media (max-width: 900px) {
            .summary-flex-row { flex-direction: column; gap: 16px; }
            #score-graph-panel, .recent-summary { min-width: 0; max-width: 100%; }
        }
    </style>
</head>
<body>
    <div class="container">
        <form class="search-bar" method="get" action="{% url 'search' %}">
            <input type="text" name="name" placeholder="ì†Œí™˜ì‚¬ëª…ì´ë‚˜ ì´ë¦„ì„ ì…ë ¥í•˜ì„¸ìš”" value="{{ query }}">
            <button type="submit">ê²€ìƒ‰</button>
        </form>
        <br/>
        <br/>
        <br/>

        {% if user %}
        <div class="summary-flex-row" style="display:flex; gap:24px; align-items:stretch; margin-bottom:32px;">
            <!-- ì™¼ìª½: ìµœê·¼ 20ê²½ê¸° ì ìˆ˜ ì„  ê·¸ë˜í”„ -->
            <div id="score-graph-panel" style="min-width:340px; flex:0 0 340px; background:#23232b; border-radius:16px; padding:18px 18px 8px 18px; display:flex; flex-direction:column; align-items:center; justify-content:center; box-shadow:0 2px 8px #0002;">
                <div style="font-size:1em; color:#bdbdbd; margin-bottom:8px;">ìµœê·¼ 20ê²½ê¸°</div>
                <canvas id="scoreLineChart" width="300" height="160"></canvas>
            </div>
            <!-- ì˜¤ë¥¸ìª½: ê¸°ì¡´ ìš”ì•½(ë„ë„›, ì±”í”¼ì–¸, í¬ì§€ì…˜) -->
            <div class="recent-summary" style="background:#23232b; border-radius:16px; padding:24px 32px; flex:1; display:flex; flex-direction:row; gap:16px; align-items:stretch; box-shadow:0 2px 8px #0002;">
                <div style="flex:1 1 0; min-width:180px; text-align:center;">
                    <div style="width:90px; height:90px; margin:0 auto 8px auto; position:relative;">
                        <svg width="90" height="90" viewBox="0 0 36 36" style="transform:rotate(-90deg);">
                            <circle cx="18" cy="18" r="16" fill="none" stroke="#c62828" stroke-width="4" />
                            <circle cx="18" cy="18" r="16" fill="none" stroke="#1976d2" stroke-width="4" stroke-dasharray="{{ win_percent }},100" stroke-dashoffset="0" />
                        </svg>
                        <span style="position:absolute; width:100%; top:32px; left:0; text-align:center; font-size:1.3em; color:#ef5350;">{{ win_percent }}%</span>
                    </div>
                    <div style="font-size:1.1em; margin-bottom:2px;">{{ stats.total }}ì „ {{ stats.win }}ìŠ¹ {{ stats.lose }}íŒ¨</div>
                    <div style="font-size:1.3em; font-weight:bold; margin-bottom:2px;">
                        <span style="color:#e0e0e0;">{{ stats.kill_avg }}</span> /
                        <span style="color:#ef5350;">{{ stats.death_avg }}</span> /
                        <span style="color:#81c784;">{{ stats.assist_avg }}</span>
                        <span style="font-size:1.5em; color:#fff; margin-left:8px;">{{ stats.kda }}</span>
                    </div>
                    <div style="color:#ffd600; font-size:1em;">Total {{ stats.total_score }}</div>
                </div>
                <div style="flex:1 1 0; min-width:320px;">
                    <div class="section-title" style="margin:0 0 8px 0;">í”Œë ˆì´í•œ ì±”í”¼ì–¸ğŸ‘‘</div>
                    <div style="display:flex; flex-direction:column; gap:8px;">
                        {% for champ in champion_stats|slice:':4' %}
                        <div style="display:flex; align-items:center; gap:8px;">
                            <img src="{% static 'img/' %}{{ champ.champion_img }}.png" style="width:32px; height:32px; border-radius:50%;">
                            <span style="font-weight:bold; color:{% if champ.winrate >= 60 %}#ef5350{% elif champ.winrate == 100 %}#81c784{% else %}#ffd600{% endif %};">{{ champ.winrate }}%</span>
                            <span style="color:#bdbdbd;">({{ champ.win }}ìŠ¹ / {{ champ.lose }}íŒ¨)</span>
                            <span style="color:#4caf50; font-weight:bold; margin-left:8px;">{{ champ.kda }} í‰ì </span>
                        </div>
                        {% empty %}
                        <div style="color:#bdbdbd;">í”Œë ˆì´í•œ ì±”í”¼ì–¸ ë°ì´í„° ì—†ìŒ</div>
                        {% endfor %}
                    </div>
                </div>
                <div style="flex:1 1 0; min-width:180px; text-align:center; margin-top:18px;">
                    <div class="section-title" style="margin:0 10px 8px 0;">ì„ í˜¸ í¬ì§€ì…˜</div>
                    <div style="display:flex; gap:8px; align-items:end; height:80px; justify-content:center;">
                        {% for bar in line_bars %}
                        <div style="width:26px; height:{{ bar.height }}px; background:{{ bar.color }}; border-radius:6px 6px 0 0;"></div>
                        {% endfor %}
                    </div>
                    <div style="display:flex; gap:8px; justify-content:center; margin-top:4px; font-size:1.2em; color:#bdbdbd;">
                        {% for bar in line_bars %}
                        <span>{{ bar.icon }}</span>
                        {% endfor %}
                    </div>
                </div>
            </div>
        </div>

        <!-- ìƒë‹¨ ìš”ì•½ê³¼ ë™ì¼ í­ìœ¼ë¡œ ì ìˆ˜ë³€ë™ ê·¸ë˜í”„ ë°°ì¹˜ -->
        {% if score_graph_data %}
        <!-- ì ìˆ˜ ë³€ë™ ê·¸ë˜í”„ ì „ì²´ ì‚­ì œ -->
        {% endif %}

        <!-- í•˜ë‹¨ 2ë‹¨(ì¢Œ:íŒ€ì›, ìš°:ê²½ê¸°ê¸°ë¡) - ê°™ì€ ë†’ì´ -->
        <div class="content-grid">
            <!-- 2ë²ˆ: ê°™ì€ íŒ€ ì†Œí™˜ì‚¬ (ì™¼ìª½) -->
            <div class="panel">
                <div class="section-title">ê°™ì€ íŒ€ìœ¼ë¡œ ê²Œì„í•œ ì†Œí™˜ì‚¬ë“¤ğŸ§‘ğŸ»â€â¤ï¸â€ğŸ’‹â€ğŸ§‘ğŸ»</div>
                <div class="team-list" style="background:none; padding:0; flex:1 1 auto;">
                    {% for team in team_users %}
                    <div class="team-user">
                        <img src="{% static 'img/logo.png' %}">
                        <div class="team-user-info">
                            <span class="team-user-name">{{ team.name }}</span>
                        </div>
                        <div class="team-user-record">{{ team.win }}ìŠ¹ / {{ team.lose }}íŒ¨<br>{{ team.games }} ê²Œì„</div>
                        <div class="team-user-winrate {% if team.winrate >= 60 %}green{% elif team.winrate <= 40 %}red{% endif %}">{{ team.winrate }}%</div>
                    </div>
                    {% empty %}
                    <div style="color:#bdbdbd; padding:16px;">ê°™ì´ í•œ íŒ€ì›ì´ ì—†ìŠµë‹ˆë‹¤.</div>
                    {% endfor %}
                </div>
            </div>

            <!-- 3ë²ˆ: ê²Œì„ ê¸°ë¡ (ì˜¤ë¥¸ìª½) -->
            <div class="panel-large" style="min-width:600px; max-width:1400px; width:100%;">
                <div class="section-title">ê²Œì„ ê¸°ë¡ğŸ®</div>

                <div class="game-list" style="flex:1 1 auto;">
                    {% for game in game_records %}
                    <div class="game-card {% if game.result == 'lose' %}lose{% else %}win{% endif %}" style="display:flex; justify-content:space-between; align-items:center; background:{% if game.result == 'lose' %}#d32f2f{% else %}#1565c0{% endif %}; color:#fff; border:none;">
                        <!-- ì™¼ìª½: ì£¼ìš” ì •ë³´ -->
                        <div style="display:flex; align-items:center; gap:16px;">
                            <div class="game-champion">
                                <img src="{% static 'img/' %}{{ game.champion_img }}.png">
                            </div>

                            <div class="game-info" style="text-align:left;">
                                <div class="game-kda" style="display:flex; align-items:center; gap:4px; font-size:1.1em; font-weight:bold;">
                                    <span>{{ game.kill }}</span> / <span class="death">{{ game.death }}</span> / <span>{{ game.assist }}</span> <span class="score">{{ game.kda }} í‰ì </span>
                                    {% if game.rank_title %}
                                    <span style="font-size:0.8em; color:#fff; margin-left:4px; font-weight:bold;">{{ game.rank_title }}</span>
                                    {% endif %}
                                </div>
                                <div style="display:flex; gap:12px; margin-top:4px; font-size:0.9em; color:#bdbdbd;">
                                    <span>KP: {{ game.kp|default:"-" }}%</span>
                                    <span>Rank: {% if game.score_change > 0 %}+{% endif %}{{ game.score_change|default:"-" }} </span>
                                    <span>Score: {{ game.after_score }}ğŸ”¥</span>
                                </div>
                                <div class="game-vs" style="display:flex; gap:12px; margin-top:4px; font-size:0.9em; color:#bdbdbd;">ìƒëŒ€: {{ game.opponent }}</div>
                            </div>
                            <!-- placement, ai score ë°•ìŠ¤ -->
                            <div style="display:flex; gap:6px; align-items:center; position:absolute; right: 520px; top:50%; transform:translateY(-50%);">
                                <div style="background:{% if game.ai_score < 50 %}#ef5350{% elif game.ai_score >= 50 and game.ai_score < 80 %}#4caf50{% elif game.ai_score >= 80 and game.ai_score < 90 %}#ffd600{% else %}#9c27b0{% endif %}; color:{% if game.ai_score >= 80 and game.ai_score < 90 %}#000{% else %}#fff{% endif %}; border-radius:12px; padding:8px 18px; min-width:20px; text-align:center; font-weight:bold; font-size:1.05em; box-shadow:0 2px 8px #0002;">
                                    {{ game.ai_score }}
                                </div>
                                <div style="background:#fff; color:#23232b; border-radius:12px; padding:8px 18px; min-width:20px; text-align:center; font-weight:bold; font-size:1em; box-shadow:0 2px 8px #0002;">
                                    {{ game.placement }}
                                </div>
                            </div>
                        </div>
                        <!-- ì˜¤ë¥¸ìª½: ìŠ¹ë¦¬íŒ€/íŒ¨ë°°íŒ€ 2ì—´ 5í–‰ -->
                        <table style="width:auto; border-collapse:separate; border-spacing:8px 2px; background:none;">
                          {% for win, lose in game.win_users|zip:game.lose_users %}
                          <tr>
                            <!-- ìŠ¹ë¦¬íŒ€ -->
                            <td style="text-align:right; padding:0 4px;">
                              <img src="{% static 'img/' %}{{ win.champion_img }}.png" style="width:18px; height:18px; border-radius:50%; border:2px solid #fff;">
                            </td>
                            <td style="text-align:right; padding:0 4px;">
                              <a href="?name={{ win.name }}" style="font-size:0.8em; color:#fff;">{{ win.name }}</a>
                            </td>
                            <td style="text-align:right; padding:0 4px;">
                              <span style="font-size:0.8em; color:#ffd600;">({{ win.kill }}/{{ win.death }}/{{ win.assist }})</span>
                              <span style="font-size:0.75em; color:#b2ebf2; margin-left:4px;">{{ win.ai_score }}{{ win.ai_emoji }}</span>
                            </td>
                            <!-- VS êµ¬ë¶„ì„  -->
                            <td style="text-align:center; color:#fff; padding:0 4px;">vs</td>
                            <!-- íŒ¨ë°°íŒ€ -->
                            <td style="text-align:left; padding:0 4px;">
                                <span style="font-size:0.75em; color:#b2ebf2; margin-left:4px;">{{ lose.ai_emoji }}{{ lose.ai_score }}</span>
                                <span style="font-size:0.8em; color:#ffd600;">({{ lose.kill }}/{{ lose.death }}/{{ lose.assist }})</span>
                            </td>
                            <td style="text-align:left; padding:0 4px;">
                                <a href="?name={{ lose.name }}" style="font-size:0.8em; color:#fff;">{{ lose.name }}</a>
                            </td>
                            <td style="text-align:left; padding:0 4px;">
                              <img src="{% static 'img/' %}{{ lose.champion_img }}.png" style="width:18px; height:18px; border-radius:50%; border:2px solid #fff;">
                            </td>
                          </tr>
                          {% endfor %}
                        </table>
                    </div>
                    {% empty %}
                    <div style="color:#bdbdbd; padding:16px;">ê²Œì„ ê¸°ë¡ì´ ì—†ìŠµë‹ˆë‹¤.ğŸ˜’</div>
                    {% endfor %}
                </div>

                {% if is_paginated %}
                <div style="display:flex; justify-content:center; gap:8px; margin-top:24px;">
                    {% if page_obj.has_previous %}
                        <a href="?name={{ query }}&page={{ page_obj.previous_page_number }}" style="color:#90caf9; text-decoration:none; font-weight:bold;">ì´ì „</a>
                    {% endif %}
                    {% for num in page_range %}
                        {% if num == page_number %}
                            <span style="color:#ffd600; font-weight:bold;">{{ num }}</span>
                        {% elif num >= page_number|add:'-2' and num <= page_number|add:'2' %}
                            <a href="?name={{ query }}&page={{ num }}" style="color:#90caf9; text-decoration:none;">{{ num }}</a>
                        {% endif %}
                    {% endfor %}
                    {% if page_obj.has_next %}
                        <a href="?name={{ query }}&page={{ page_obj.next_page_number }}" style="color:#90caf9; text-decoration:none; font-weight:bold;">ë‹¤ìŒ</a>
                    {% endif %}
                </div>
                {% endif %}
            </div>
        </div>
        {% else %}
        <div style="color:#bdbdbd; padding:32px; text-align:center;">ì†Œí™˜ì‚¬ëª…ì´ë‚˜ ì´ë¦„ì„ ê²€ìƒ‰í•´ì£¼ì„¸ìš”.ğŸ”¥</div>
        {% endif %}
    </div>
    <!-- Chart.js CDN -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script>
      const recentScores = {{ recent_scores|safe }};
      const ctx = document.getElementById('scoreLineChart').getContext('2d');
      const labels = recentScores.map(s => s.date);
      const data = recentScores.map(s => s.total_score);
      const pointColors = recentScores.map(s => s.result === 'win' ? '#4caf50' : '#ef5350');
      const chart = new Chart(ctx, {
        type: 'line',
        data: {
          labels: labels,
          datasets: [{
            label: 'Total Score',
            data: data,
            borderColor: '#4caf50',
            backgroundColor: 'rgba(76,175,80,0.1)',
            pointBackgroundColor: pointColors,
            pointRadius: 5,
            pointHoverRadius: 8,
            fill: true,
            tension: 0.3,
          }]
        },
        options: {
          responsive: false,
          plugins: {
            legend: { display: false },
            tooltip: {
              enabled: true,
              callbacks: {
                title: (items) => `${items[0].label}`,
                label: (item) => `ì ìˆ˜: ${item.parsed.y}`
              }
            }
          },
          scales: {
            x: {
              display: true,
              title: { display: false },
              ticks: { color: '#bdbdbd', maxRotation: 0, minRotation: 0 }
            },
            y: {
              display: true,
              title: { display: false },
              ticks: { color: '#bdbdbd' },
              beginAtZero: false
            }
          }
        }
      });
    </script>
  </body>
</html>
