{% load static %}
{% include 'lolapp/header.html' %}
<link rel="stylesheet" href="{% static 'header.css' %}">
<!DOCTYPE html>
<html lang="ko">
<head>
    {% load static %}
    <meta charset="UTF-8">
    <title>경기결과입력</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/all.min.css">
    <style>
        body { background: #23232b; font-family: 'Segoe UI', Arial, sans-serif; }
        .flex { display: flex; gap: 32px; justify-content: center; margin-top: 40px; }
        .champion-list { width: 290px; background: #222; color: #fff; border-radius: 8px; padding: 12px; min-height: 400px; }
        .table-wrap { background: #fff; border-radius: 10px; padding: 18px; max-width: 800px; }
        table { border-collapse: collapse; margin-top: 30px; min-width: 800px; }
        th, td { border: 1px solid #bdbdbd; padding: 4px 2px; text-align: center; }
        th { background: #23232b; color: #fff; font-size: 0.98em; }
        .icon-cell { /* width: 38px; */ }
        select { padding: 2px 4px; }
        .champion-cell-img {
            width: 32px;
            height: 32px;
            border-radius: 6px;
            border: 1px solid #888;
            background: #222;
            object-fit: cover;
        }
        .champion-cell-empty {
            width: 32px; height: 32px; display: inline-block; background: #eee; border-radius: 6px; border: 1px dashed #bbb;
        }
    </style>
</head>
<body>
<form method="post" action="" autocomplete="off">
{% csrf_token %}
<div style="max-width:800px; margin:0 auto 24px auto; background:#23232b; border-radius:10px; padding:18px 24px 12px 24px; color:#fff;">
    <div style="font-weight:bold; font-size:1.08em; margin-bottom:8px;">복사한 게임 결과 텍스트 붙여넣기</div>
    <textarea id="bulk-textarea" rows="12" style="width:100%; border-radius:8px; border:1px solid #bbb; padding:10px; font-size:1em; margin-bottom:8px; resize:vertical; background:#181824; color:#fff;"></textarea>
    <button type="button" id="analyze-btn" style="background:#4a6cf7; color:#fff; border:none; border-radius:6px; padding:8px 28px; font-size:1em; font-weight:bold; cursor:pointer; margin-bottom:8px;">분석</button>
    <div style="font-size:0.95em; color:#ffe082; margin-top:4px;">복사한 게임 결과 텍스트를 붙여넣고 '분석'을 누르면 자동으로 입력됩니다.</div>
</div>
<div id="analyze-preview" style="max-width:800px; margin:0 auto 24px auto; background:#181824; border-radius:10px; padding:16px 24px; color:#fff; font-size:1em; display:none;"></div>

<!-- 저장 완료 모달 -->
<div id="save-modal" style="display:none; position:fixed; left:0; top:0; width:100vw; height:100vh; background:rgba(0,0,0,0.4); z-index:1000; align-items:center; justify-content:center;">
  <div style="background:#23232b; color:#fff; border-radius:12px; padding:32px 36px; min-width:320px; text-align:center; box-shadow:0 4px 24px #0008;">
    <div style="font-size:1.15em; margin-bottom:18px;">저장 완료!<br>저장 내용을 확정하시겠습니까?</div>
    <button id="modal-confirm" style="background:#43a047; color:#fff; border:none; border-radius:6px; padding:8px 28px; font-size:1em; font-weight:bold; margin-right:16px; cursor:pointer;">확인</button>
    <button id="modal-cancel" style="background:#b71c1c; color:#fff; border:none; border-radius:6px; padding:8px 28px; font-size:1em; font-weight:bold; cursor:pointer;">취소</button>
  </div>
</div>
</form>
<script>
// 분석 전 textarea 백업용
let textareaBackup = "";

// 분석 버튼 클릭 시 DB 저장 + 모달 표시
const analyzeBtn = document.getElementById('analyze-btn');
const saveModal = document.getElementById('save-modal');
const modalConfirm = document.getElementById('modal-confirm');
const modalCancel = document.getElementById('modal-cancel');
const textarea = document.getElementById('bulk-textarea');

analyzeBtn.onclick = function() {
    textareaBackup = textarea.value; // 분석 전 상태 백업
    const data = textarea.value;
    try {
        const jsonData = JSON.parse(data);
        fetch("/upload/save/", {
            method: "POST",
            headers: {
                "Content-Type": "application/json",
                "X-CSRFToken": document.querySelector('[name=csrfmiddlewaretoken]')?.value || "",
            },
            body: JSON.stringify(jsonData)
        })
        .then(res => {
            if (!res.ok) throw new Error('서버 응답 오류: ' + res.status);
            return res.json();
        })
        .then(res => {
            if(res.success) {
                saveModal.style.display = 'flex';
            } else {
                alert("저장 실패: " + res.error);
            }
        })
        .catch(err => {
            console.error('분석 버튼 오류:', err);
            alert('분석 중 오류가 발생했습니다: ' + err.message);
        });
    } catch(e) {
        alert("JSON 형식이 올바르지 않습니다.");
    }
};

// 모달 확인: 저장 확정(그대로 두고 모달만 닫음)
modalConfirm.onclick = function() {
    saveModal.style.display = 'none';
    alert('저장이 확정되었습니다!');
};
// 모달 취소: 분석 전 상태로 롤백
modalCancel.onclick = function() {
    saveModal.style.display = 'none';
    textarea.value = textareaBackup;
    alert('저장이 취소되었습니다.');
};
</script>
</body>
</html> 